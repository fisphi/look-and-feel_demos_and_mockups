<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>DIVINA look&feel DEMO: Tabulator-JS Demo Attribute</title>

    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

    <style>
        /* NEW: pastel theme */
        :root{
            --primary: #C9C1FF;   /* pastel purple */
            --accent-1: #CFF6E6;  /* pastel mint */
            --accent-2: #FFDDE0;  /* pastel coral */
            --muted: #7f8a9b;
            --bg: #fbfdff;
        }

        body {
            font-family: "Inter", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(180deg,#fcfeff,#fbfdff);
            color: #0f172a;
        }

        /* Container f√ºr zentrierte maximale Breite */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        h2 {
            font-weight: 700;
            margin-bottom: 37px;
            background: linear-gradient(90deg,var(--primary),#BEE7FF);
            -webkit-background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-top: -28px;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        #attribute-table {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(12,18,30,0.035);
            overflow: hidden;
            width: 100%; /* volle Breite nutzen */
        }

        .tabulator { border: none; }
        .tabulator .tabulator-header { background: rgba(201,193,255,0.06); } /* pastel header tint */
        .tabulator .tabulator-cell { padding: 8px 10px; vertical-align: middle; }

        .cell-longtext {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px; /* slightly reduced */
            cursor: pointer;
            color: #0b1220;
        }

        .cell-id {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            color: #0b1220;
        }

        .cell-kommentar {
            white-space: normal;
            word-wrap: break-word;
            color: #0b1220;
            line-height: 1.4;
        }

        .chip-container {
            margin-bottom: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; /* chips links */
            gap: 8px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            margin-right: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #07203b;
            box-shadow: 0 2px 6px rgba(15,23,42,0.02);
        }

        /* pastel chip variants */
        .chip.attribut { background: linear-gradient(90deg,#fff8e6,#fff0cc); color:#6a4d00; }
        .chip.stammattribut { background: linear-gradient(90deg,#f0fff6,#dff6ea); color:#054d36; }
        .chip.thesaurus { background: linear-gradient(90deg,#f5f4ff,#e4ddff); color:#2a2355; }
        .chip.type { background: linear-gradient(90deg,#e6f5ff,#d6ecff); color:#023a6d; } /* pastel chip variant for Type */
        .chip.publish { color:#0b3a6b; } /* base publish chip */
        .chip.publish.publish-true { background: linear-gradient(90deg,#e8fbf0,#d9f5e5); color:#0b7a4b; }
        .chip.publish.publish-false { background: linear-gradient(90deg,#ffecec,#ffd4d4); color:#8f1b1b; }
        .chip.sammlung { background: linear-gradient(90deg,#fff4e6,#ffe8cc); color:#7c4a00; }

        .chip span {
            margin-left: 8px;
            cursor: pointer;
            font-weight: 700;
            opacity: 0.9;
        }

        .hl {
            background: yellow;
            font-weight: bold;
        }

        .multi-select {
            width: 100%;
            height: 32px; /* gleiche H√∂he wie text inputs */
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 13px;
            border: 1px solid rgb(0, 0, 0, 0.5);
            background: #fff;
        }

        /* Text input filters: same design as dropdowns */
        .tabulator-header-filter input[type="text"],
        .tabulator-header-filter input[type="search"] {
            width: 100%;
            height: 32px;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 13px;
            border: 1px solid rgba(201,193,255,0.25);
            background: #fff;
            color: #0f172a;
            box-sizing: border-box;
        }
        .tabulator-header-filter input:focus {
            outline: none;
            border-color: rgba(201,193,255,0.5);
        }

        /* Attributtyp cell colors */
        .attributtyp-cell { font-weight: 600; }
        .attributtyp-cell.attribut { color: #d97706; }           /* orange/amber */
        .attributtyp-cell.stammattribut { color: #059669; }      /* emerald green */
        .attributtyp-cell.thesaurus { color: #7c3aed; }          /* violet */

        /* publish icon -> pastel pills */
        .publish-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            font-size: 13px;
        }
        .publish-icon.true { background: linear-gradient(90deg,#E8FBF0,#DFF6E6); color:#0b7a4b; }
        .publish-icon.false { background: linear-gradient(90deg,#FFEFEF,#FFDCDC); color:#9b2b2b; }

        /* edit icon pill -> pastel */
        .edit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 34px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            color: #111;               /* schwarze Kontur f√ºr Icon */
            font-size: 0;              /* Text ausblenden, nur SVG sichtbar */
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.06);
            padding: 6px;
            transition: background .12s ease;
        }
        .edit-btn:hover { background: rgba(0,0,0,0.03); }

        .edit-btn svg {
            width: 16px;
            height: 16px;
            transform: rotate(-20deg); /* schr√§ger Bleistift */
            stroke: currentColor;
            stroke-width: 1.6;
            fill: none;
        }

        /* Reset button styling */
        #resetFilters {
            background: linear-gradient(180deg,#ffffff,#fcfcff);
            border: 1px solid #ff6b6b; /* red border */
            color: #9b2b2b;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(2,6,23,0.03);
            margin-bottom: 0;
        }
        #resetFilters:hover {
            background: linear-gradient(180deg,#fff7f7,#fff0f0);
            border-color: #e55353;
            box-shadow: 0 6px 14px rgba(229,83,83,0.08);
        }

        /* controls row: reset button (left) and chips (right) */
        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* responsive: stack controls on small screens */
        @media (max-width: 520px) {
            .controls-row { flex-direction: column; align-items: stretch; gap: 8px; }
            .chip-container { justify-content: flex-start; }
        }

        /* Modal overlay */
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15,23,42,0.4);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        #editModal.active { display: flex; }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 12px 40px rgba(12,18,30,0.15);
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal-field {
            margin-bottom: 16px;
        }
        .modal-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
        }
        .modal-field input,
        .modal-field textarea,
        .modal-field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(201,193,255,0.25);
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }
        .modal-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        .modal-btn.save {
            background: linear-gradient(90deg,var(--primary),#a89fff);
            color: #fff;
        }

        /* Tooltip for long text hover */
        #textTooltip {
            display: none;
            position: fixed;
            background: #fff;
            border: 1px solid rgba(201,193,255,0.3);
            border-radius: 8px;
            padding: 12px 14px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(12,18,30,0.12);
            z-index: 10000;
            font-size: 13px;
            line-height: 1.5;
            color: #0f172a;
            pointer-events: none;
            white-space: pre-wrap;
        }
        #textTooltip.active { display: block; }

        /* Pagination styling */
        .tabulator-footer {
            background: rgba(201,193,255,0.03);
            border-top: 1px solid rgba(201,193,255,0.1);
            padding: 12px;
        }
        .tabulator-page {
            border: 1px solid rgba(201,193,255,0.2);
            background: #fff;
            color: var(--primary);
            border-radius: 6px;
            padding: 6px 10px;
            margin: 0 3px;
        }
        .tabulator-page.active {
            background: var(--primary);
            color: #fff;
        }
        .tabulator-page:hover:not(.disabled) {
            background: rgba(201,193,255,0.1);
        }

        /* Horizontal collapse layout */
        .tabulator-responsive-collapse {
            padding: 12px 16px !important;
            background: rgba(201,193,255,0.02) !important;
        }
        .tabulator-responsive-collapse table {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 16px !important;
            width: 100% !important;
        }
        .tabulator-responsive-collapse tr {
            display: flex !important;
            flex-direction: column !important;
            min-width: 180px !important;
            flex: 1 1 auto !important;
        }
        .tabulator-responsive-collapse td {
            display: block !important;
            padding: 4px 0 !important;
            border: none !important;
        }
        .tabulator-responsive-collapse td:first-child {
            font-weight: 600 !important;
            color: var(--muted) !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            margin-bottom: 2px !important;
        }
        .tabulator-responsive-collapse td:last-child {
            font-size: 14px !important;
            color: #0f172a !important;
        }
    </style>

</head>

<body>
    <div class="container">
        <h2>Tabulator-JS Demo: Attribute</h2>
        <p class="subtitle">
            Interaktive Tabelle mit Facetten-Filtern, 
            Chip-basierter Filteranzeige, Responsive Collapse f√ºr mobile Ansichten, 
            Hover-Tooltips f√ºr Langtext-Felder, Edit-Modal f√ºr Inline-Bearbeitung 
            und farbcodierten Attributtypen.
        </p>

        <div class="controls-row">
            <!-- Facet Chips (links) -->
            <div id="facet-chips" class="chip-container"></div>
            <!-- Reset Button (rechts) -->
            <button id="resetFilters">Reset All Filters</button>
        </div>

        <div class="controls-row">
            <input type="text" id="globalSearch" class="multi-select" placeholder="Global Search" />
        </div>

        <!-- Tabelle -->
        <div id="attribute-table"></div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal">
        <div class="modal-content">
            <div class="modal-header">Attribut bearbeiten</div>
            <div class="modal-field">
                <label>Attributtyp</label>
                <input type="text" id="modal-attributtyp" readonly />
            </div>
            <div class="modal-field">
                <label>Name</label>
                <input type="text" id="modal-name" />
            </div>
            <div class="modal-field">
                <label>ID</label>
                <input type="text" id="modal-id" readonly />
            </div>
            <div class="modal-field">
                <label>Type</label>
                <input type="text" id="modal-type" />
            </div>
            <div class="modal-field">
                <label>Public</label>
                <select id="modal-publish">
                    <option value="true">Ja</option>
                    <option value="false">Nein</option>
                </select>
            </div>
            <div class="modal-field">
                <label>Infotext</label>
                <textarea id="modal-infotext"></textarea>
            </div>
            <div class="modal-field">
                <label>Kommentar</label>
                <textarea id="modal-kommentar"></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="modalCancel">Abbrechen</button>
                <button class="modal-btn save" id="modalSave">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Tooltip for long text -->
    <div id="textTooltip"></div>

    <script>
        (function () {
            const chipContainer = document.getElementById("facet-chips");
            const resetFiltersButton = document.getElementById("resetFilters");
            const tooltipElement = document.getElementById("textTooltip");
            const editModal = document.getElementById("editModal");
            const globalSearchInput = document.getElementById("globalSearch");

            const modalFields = {
                attributtyp: document.getElementById("modal-attributtyp"),
                name: document.getElementById("modal-name"),
                id: document.getElementById("modal-id"),
                type: document.getElementById("modal-type"),
                publish: document.getElementById("modal-publish"),
                infotext: document.getElementById("modal-infotext"),
                kommentar: document.getElementById("modal-kommentar")
            };

            const modalButtons = {
                cancel: document.getElementById("modalCancel"),
                save: document.getElementById("modalSave")
            };

            const LOREM_PARTS = [
                "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
                "Praesent mauris. Fusce nec tellus sed augue semper porta. Praesent mauris. Fusce nec tellus sed augue semper porta.",
                "Class aptent taciti sociosqu ad litora torquent per conubia. Praesent mauris. ",
                "Integer nec odio. Praesent libero. Sed cursus ante dapibus.",
                "Duis sagittis ipsum.  "
            ];

            function loremMix() {
                const pick = () => LOREM_PARTS[Math.floor(Math.random() * LOREM_PARTS.length)];
                return `${pick()} ${pick()}`;
            }

            const tableData = [
                { attributtyp: "Attribut", name: "Description", id: "ATT-00068", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 4588, created_by: "Admin", created_at: "2023-01-15", updated_by: "Editor", updated_at: "2024-03-20" },
                { attributtyp: "Attribut", name: "Height", id: "ATT-00065", type: "Metric (4)", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 3201, created_by: "System", created_at: "2022-11-10", updated_by: "Admin", updated_at: "2024-02-14" },
                { attributtyp: "Attribut", name: "Diameter", id: "ATT-00077", type: "Metric (0)", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 1542, created_by: "Editor", created_at: "2023-05-22", updated_by: "Editor", updated_at: "2024-01-08" },
                { attributtyp: "Attribut", name: "DNA comment", id: "ATT-00004", type: "Textarea", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 892, created_by: "Admin", created_at: "2023-02-18", updated_by: "System", updated_at: "2024-03-15" },
                { attributtyp: "Attribut", name: "DNA extraction", id: "ATT-00005", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MY", anzahl_objekte: 1200, created_by: "Admin", created_at: "2023-03-10", updated_by: "Editor", updated_at: "2024-02-20" },
                { attributtyp: "Attribut", name: "DNA Storage", id: "ATT-00006", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 750, created_by: "System", created_at: "2023-04-05", updated_by: "Admin", updated_at: "2024-01-25" },
                { attributtyp: "Stammattribut", name: "Inventory History", id: "ATT-00038", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MY, MO, MIN", anzahl_objekte: 4588, created_by: "Admin", created_at: "2023-01-15", updated_by: "Editor", updated_at: "2024-03-20" },
                { attributtyp: "Attribut", name: "Editor", id: "ATT-00029", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 3201, created_by: "System", created_at: "2022-11-10", updated_by: "Admin", updated_at: "2024-02-14" },
                { attributtyp: "Attribut", name: "Examination Comment", id: "ATT-00053", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MIN", anzahl_objekte: 1542, created_by: "Editor", created_at: "2023-05-22", updated_by: "Editor", updated_at: "2024-01-08" },
                { attributtyp: "Attribut", name: "Expedition", id: "ATT-00026", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MIN", anzahl_objekte: 892, created_by: "Admin", created_at: "2023-02-18", updated_by: "System", updated_at: "2024-03-15" },
                { attributtyp: "Attribut", name: "General Topic", id: "ATT-00033", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 1200, created_by: "Admin", created_at: "2023-03-10", updated_by: "Editor", updated_at: "2024-02-20" },
                { attributtyp: "Thesaurus", name: "Habitat", id: "ATT-00023", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MY, MO", anzahl_objekte: 750, created_by: "System", created_at: "2023-04-05", updated_by: "Admin", updated_at: "2024-01-25" },
                { attributtyp: "Attribut", name: "Individuum comment", id: "ATT-00010", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 4588, created_by: "Admin", created_at: "2023-01-15", updated_by: "Editor", updated_at: "2024-03-20" },
                { attributtyp: "Attribut", name: "Field number", id: "ATT-00007", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS, MIN", anzahl_objekte: 3201, created_by: "System", created_at: "2022-11-10", updated_by: "Admin", updated_at: "2024-02-14" },
                { attributtyp: "Attribut", name: "Iris", id: "ATT-00058", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 1542, created_by: "Editor", created_at: "2023-05-22", updated_by: "Editor", updated_at: "2024-01-08" },
                { attributtyp: "Thesaurus", name: "Label printed", id: "ATT-00051", type: "Yes/No", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 892, created_by: "Admin", created_at: "2023-02-18", updated_by: "System", updated_at: "2024-03-15" },
                { attributtyp: "Stammattribut", name: "Inventorybook origin name", id: "ATT-00011", type: "Text", publish: false, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 1200, created_by: "Admin", created_at: "2023-03-10", updated_by: "Editor", updated_at: "2024-02-20" },
                { attributtyp: "Attribut", name: "from captivity", id: "ATT-00046", type: "Yes/No", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 750, created_by: "System", created_at: "2023-04-05", updated_by: "Admin", updated_at: "2024-01-25" },
                { attributtyp: "Thesaurus", name: "Datasource", id: "ATT-00003", type: "Text", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 4588, created_by: "Admin", created_at: "2023-01-15", updated_by: "Editor", updated_at: "2024-03-20" },
                { attributtyp: "Attribut", name: "Count (male)", id: "ATT-00016", type: "Metric (0)", publish: true, infotext: loremMix(), kommentar: loremMix(), sammlung: "VS", anzahl_objekte: 3201, created_by: "System", created_at: "2022-11-10", updated_by: "Admin", updated_at: "2024-02-14" }
            ];

            const FIELD_WEIGHTS = {
                name: 5,
                id: 4,
                attributtyp: 3,
                infotext: 2,
                kommentar: 1
            };
            const DEFAULT_WEIGHT = 1;

            function createDefaultFilters() {
                return {
                    attributtyp: null,
                    type: null,
                    publish: null,
                    sammlung: null
                };
            }

            let activeFilters = createDefaultFilters();
            let globalSearchQuery = "";
            let currentEditRow = null;
            let table = null;

            function createSelectFilter(options, onChange) {
                const select = document.createElement("select");
                select.className = "multi-select";

                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "All";
                select.appendChild(defaultOption);

                options.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.textContent = option.label;
                    select.appendChild(opt);
                });

                select.addEventListener("change", () => onChange(select.value));
                return select;
            }

            function getUniqueValues(data, field) {
                return Array.from(new Set(data.map(item => item[field]))).sort();
            }

            function resetSelectElement(select) {
                if (select.multiple) {
                    select.querySelectorAll("option").forEach(option => {
                        option.selected = false;
                    });
                } else {
                    select.value = "";
                }
                select.dispatchEvent(new Event("change", { bubbles: true }));
            }

            function resetHeaderFilters() {
                document.querySelectorAll("select.multi-select").forEach(resetSelectElement);
            }

            function clearFilterValue(filterType, value) {
                const currentValue = activeFilters[filterType];

                if (Array.isArray(currentValue)) {
                    activeFilters[filterType] = currentValue.filter(item => item !== value);
                    if (activeFilters[filterType].length === 0) {
                        activeFilters[filterType] = null;
                    }
                } else {
                    activeFilters[filterType] = null;
                }
            }

            function buildChip({ cssClass, label, filterKey, value }) {
                const chip = document.createElement("div");
                chip.className = `chip ${cssClass}`;
                chip.innerHTML = `${label} <span data-type="${filterKey}" data-value="${value}">√ó</span>`;
                chip.querySelector("span").onclick = () => {
                    clearFilterValue(filterKey, value);
                    updateFilter();
                };
                return chip;
            }

            function renderChips() {
                chipContainer.innerHTML = "";

                if (activeFilters.attributtyp) {
                    const value = activeFilters.attributtyp;
                    chipContainer.appendChild(buildChip({
                        cssClass: value.toLowerCase().replace(/\s/g, ""),
                        label: `Attributtyp: ${value}`,
                        filterKey: "attributtyp",
                        value
                    }));
                }

                if (activeFilters.type) {
                    chipContainer.appendChild(buildChip({
                        cssClass: "type",
                        label: `Type: ${activeFilters.type}`,
                        filterKey: "type",
                        value: activeFilters.type
                    }));
                }

                if (activeFilters.publish !== null) {
                    const text = activeFilters.publish ? "Yes" : "No";
                    chipContainer.appendChild(buildChip({
                        cssClass: `publish ${activeFilters.publish ? "publish-true" : "publish-false"}`,
                        label: `Public: ${text}`,
                        filterKey: "publish",
                        value: activeFilters.publish
                    }));
                }

                if (activeFilters.sammlung) {
                    chipContainer.appendChild(buildChip({
                        cssClass: "sammlung",
                        label: `Sammlung: ${activeFilters.sammlung}`,
                        filterKey: "sammlung",
                        value: activeFilters.sammlung
                    }));
                }
            }

            function sanitizeTooltipContent(text) {
                return (text || "").replace(/'/g, "&apos;");
            }

            function positionTooltip(event) {
                const x = event.clientX + 15;
                const y = event.clientY + 15;
                tooltipElement.style.left = `${x}px`;
                tooltipElement.style.top = `${y}px`;
            }

            function showTooltip(event, text) {
                tooltipElement.innerHTML = text;
                tooltipElement.classList.add("active");
                positionTooltip(event);
            }

            function showIDTooltip(event, id) {
                tooltipElement.textContent = `ID: ${id}\nSammlung: VS\nObjekte: 4588`;
                tooltipElement.classList.add("active");
                positionTooltip(event);
            }

            function hideTooltip() {
                tooltipElement.classList.remove("active");
            }

            function normalizeValue(value) {
                if (value === null || value === undefined) {
                    return "";
                }
                return typeof value === "string" ? value : String(value);
            }

            function computeMatchPositions(text, query) {
                const source = normalizeValue(text);
                const needle = normalizeValue(query).trim();
                if (!needle) return null;

                const haystack = source.toLowerCase();
                const target = needle.toLowerCase();
                const startIndex = haystack.indexOf(target);

                if (startIndex === -1) return null;

                const positions = [];
                for (let i = 0; i < target.length; i++) {
                    positions.push(startIndex + i);
                }
                return positions;
            }

            function fuzzyMatch(query, text) {
                const positions = computeMatchPositions(text, query);
                return positions ? positions.length : 0;
            }

            function fuzzyHighlight(text, query) {
                const value = normalizeValue(text);
                const positions = computeMatchPositions(value, query);
                if (!positions || positions.length === 0) {
                    return value;
                }

                const lookup = new Set(positions);
                let highlighted = "";

                for (let i = 0; i < value.length; i++) {
                    const char = value[i];
                    highlighted += lookup.has(i) ? `<span class="hl">${char}</span>` : char;
                }

                return highlighted;
            }

            function weightedRowScore(data, query) {
                const normalizedQuery = normalizeValue(query).trim();
                if (!normalizedQuery) return 0;

                return Object.keys(data).reduce((score, key) => {
                    const value = normalizeValue(data[key]);
                    if (!value) return score;

                    const matchScore = fuzzyMatch(normalizedQuery, value);
                    if (!matchScore) return score;

                    const weight = FIELD_WEIGHTS[key] || DEFAULT_WEIGHT;
                    return score + (matchScore * weight);
                }, 0);
            }

            function attributtypHeaderFilter() {
                const values = ["Attribut", "Stammattribut", "Thesaurus"].map(value => ({ value, label: value }));
                return createSelectFilter(values, (value) => {
                    activeFilters.attributtyp = value || null;
                    updateFilter();
                });
            }

            function typeHeaderFilter() {
                const values = getUniqueValues(tableData, "type").map(value => ({ value, label: value }));
                return createSelectFilter(values, (value) => {
                    activeFilters.type = value || null;
                    updateFilter();
                });
            }

            function publishHeaderFilter() {
                const values = [
                    { value: "true", label: "Publiziert" },
                    { value: "false", label: "Nicht publiziert" }
                ];
                return createSelectFilter(values, (value) => {
                    activeFilters.publish = value === "" ? null : value === "true";
                    updateFilter();
                });
            }

            function sammlungHeaderFilter() {
                const values = getUniqueValues(tableData, "sammlung").map(value => ({ value, label: value }));
                return createSelectFilter(values, (value) => {
                    activeFilters.sammlung = value || null;
                    updateFilter();
                });
            }

            function attributtypFormatter(cell) {
                const value = cell.getValue() || "";
                const cssClass = value.toLowerCase().replace(/\s/g, "");
                const highlighted = fuzzyHighlight(value, globalSearchQuery);
                return `<div class="attributtyp-cell ${cssClass}">${highlighted}</div>`;
            }

            function idFormatter(cell) {
                const value = cell.getValue() || "";
                const highlighted = fuzzyHighlight(value, globalSearchQuery);
                return `<div class="cell-id" 
                    onmouseenter="showIDTooltip(event, '${value}')" 
                    onmouseleave="hideTooltip()">${highlighted}</div>`;
            }

            function longTextFormatter(cell) {
                const value = cell.getValue() || "";
                const tooltipText = sanitizeTooltipContent(value);
                const highlighted = fuzzyHighlight(value, globalSearchQuery);
                return `<div class="cell-longtext" 
                    onmouseenter="showTooltip(event, '${tooltipText}')" 
                    onmouseleave="hideTooltip()">${highlighted}</div>`;
            }

            function kommentarFormatter(cell) {
                const value = cell.getValue() || "";
                const highlighted = fuzzyHighlight(value, globalSearchQuery);
                return `<div class="cell-kommentar">${highlighted}</div>`;
            }

            function textFormatter(cell) {
                const value = cell.getValue() || "";
                return fuzzyHighlight(value, globalSearchQuery);
            }

            function publishFormatter(cell) {
                const value = cell.getValue();
                return `<span class="publish-icon ${value ? "true" : "false"}" title="${value ? "Publiziert" : "Nicht publiziert"}">${value ? "üåê" : "üîí"}</span>`;
            }

            function editFormatter() {
                return `<button class="edit-btn" title="Edit" aria-label="Edit" onclick="openEditModal(event)">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>`;
            }

            function setModalFieldValues(data) {
                modalFields.attributtyp.value = data.attributtyp || "";
                modalFields.name.value = data.name || "";
                modalFields.id.value = data.id || "";
                modalFields.type.value = data.type || "";
                modalFields.publish.value = data.publish ? "true" : "false";
                modalFields.infotext.value = data.infotext || "";
                modalFields.kommentar.value = data.kommentar || "";
            }

            function getModalFieldValues() {
                return {
                    attributtyp: modalFields.attributtyp.value,
                    name: modalFields.name.value,
                    id: modalFields.id.value,
                    type: modalFields.type.value,
                    publish: modalFields.publish.value === "true",
                    infotext: modalFields.infotext.value,
                    kommentar: modalFields.kommentar.value
                };
            }

            function openEditModal(event) {
                event.stopPropagation();
                if (!table) return;

                const rowElement = event.target.closest(".tabulator-row");
                if (!rowElement) return;

                currentEditRow = table.getRow(rowElement);
                if (!currentEditRow) return;

                setModalFieldValues(currentEditRow.getData());
                editModal.classList.add("active");
            }

            function closeEditModal() {
                editModal.classList.remove("active");
                currentEditRow = null;
            }

            function saveEdit() {
                if (!currentEditRow) return;
                currentEditRow.update(getModalFieldValues());
                closeEditModal();
            }

            function formatPublishState(row) {
                const rowElement = row.getElement();
                if (!rowElement) return;

                if (row.getData().publish) {
                    rowElement.classList.add("published");
                } else {
                    rowElement.classList.remove("published");
                }
            }

            table = new Tabulator("#attribute-table", {
                layout: "fitColumns",
                data: tableData,
                responsiveLayout: "collapse",
                responsiveLayoutCollapseStartOpen: false,
                pagination: true,
                paginationSize: 100,
                paginationSizeSelector: [10, 20, 50, 100],
                rowFormatter: formatPublishState,
                columns: [
                    { formatter: "responsiveCollapse", width: 40, minWidth: 40, hozAlign: "center", resizable: false, headerSort: false, responsive: 0 },
                    {
                        title: "Attributtyp",
                        field: "attributtyp",
                        formatter: attributtypFormatter,
                        headerFilter: attributtypHeaderFilter,
                        width: 120,
                        responsive: 0
                    },
                    { title: "ID", field: "id", formatter: idFormatter, headerFilter: "input", width: 120, responsive: 1 },
                    { title: "Name", field: "name", formatter: textFormatter, headerFilter: "input", minWidth: 200, responsive: 0 },
                    {
                        title: "Public",
                        field: "publish",
                        formatter: publishFormatter,
                        headerFilter: publishHeaderFilter,
                        hozAlign: "center",
                        width: 90,
                        responsive: 3
                    },
                    { title: "Infotext", field: "infotext", formatter: longTextFormatter, headerFilter: "input", minWidth: 250, responsive: 10 },
                    { title: "Type", field: "type", formatter: textFormatter, headerFilter: typeHeaderFilter, width: 120, responsive: 2 },
                    { title: "in Sammlung", field: "sammlung", formatter: textFormatter, headerFilter: "input", minWidth: 80, responsive: 5 },
                    { title: "in Objekten", field: "anzahl_objekte", width: 70, responsive: 13 },
                    { title: "Ge√§ndert am", field: "updated_at", formatter: textFormatter, width: 120, responsive: 0 },
                    { title: "Erstellt von", field: "created_by", formatter: textFormatter, minWidth: 110, headerSort: false, responsive: 15 },
                    { title: "Erstellt am", field: "created_at", formatter: textFormatter, minWidth: 110, headerSort: false, responsive: 15 },
                    { title: "Ge√§ndert von", field: "updated_by", formatter: textFormatter, minWidth: 110, responsive: 14 },
                    { title: "Kommentar", field: "kommentar", formatter: kommentarFormatter, headerFilter: "input", minWidth: 250, headerSort: false, responsive: 16 },
                    { title: "", formatter: editFormatter, width: 70, hozAlign: "center", responsive: 0 }
                ]
            });

            function buildFacetFilters() {
                const filters = [];

                if (activeFilters.attributtyp) {
                    filters.push({ field: "attributtyp", type: "=", value: activeFilters.attributtyp });
                }

                if (activeFilters.publish !== null) {
                    filters.push({ field: "publish", type: "=", value: activeFilters.publish });
                }

                if (activeFilters.type) {
                    filters.push({ field: "type", type: "=", value: activeFilters.type });
                }

                if (activeFilters.sammlung) {
                    filters.push({ field: "sammlung", type: "like", value: activeFilters.sammlung });
                }

                return filters;
            }

            function globalSearchFilter(data) {
                return weightedRowScore(data, globalSearchQuery) > 0;
            }

            function applyFilters(clearHeaderFilters = false) {
                const facetFilters = buildFacetFilters();
                const hasFacetFilters = facetFilters.length > 0;
                const hasQuery = Boolean(globalSearchQuery);

                if (!hasFacetFilters && !hasQuery) {
                    table.clearFilter(clearHeaderFilters);
                    renderChips();
                    table.redraw(true);
                    return;
                }

                if (clearHeaderFilters) {
                    table.clearFilter(true);
                }

                if (hasQuery) {
                    table.setFilter(globalSearchFilter);
                    facetFilters.forEach(filter => {
                        table.addFilter(filter.field, filter.type, filter.value);
                    });
                } else if (hasFacetFilters) {
                    table.setFilter(facetFilters);
                }

                renderChips();
                table.redraw(true);
            }

            function updateFilter() {
                applyFilters(true);
            }

            function clearAllFilters() {
                activeFilters = createDefaultFilters();
            }

            resetFiltersButton.addEventListener("click", () => {
                clearAllFilters();
                globalSearchQuery = "";
                globalSearchInput.value = "";
                applyFilters(true);
                resetHeaderFilters();
            });

            globalSearchInput.addEventListener("input", (event) => {
                globalSearchQuery = (event.target.value || "").trim();
                applyFilters(false);
            });

            modalButtons.cancel.addEventListener("click", closeEditModal);
            modalButtons.save.addEventListener("click", saveEdit);

            editModal.addEventListener("click", (event) => {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });

            renderChips();

            window.showTooltip = showTooltip;
            window.showIDTooltip = showIDTooltip;
            window.hideTooltip = hideTooltip;
            window.openEditModal = openEditModal;
        })();
    </script>
</body>

</html>
